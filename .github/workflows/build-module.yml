name: Publish to PowerShell Gallery
on:
  push:
    branches:
      - main
      # - develop
    paths:
      - 'src/SvR.ContentPrep/**'
      - 'src/SvR.ContentPrep.Cmdlet/**'
      - '.github/workflows/build-module.yml'
    tags:
      - v*
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: üë®‚Äçüíª Check-out code
        uses: actions/checkout@v4
        # Specify depth because of GitVersion
        with:
          fetch-depth: 0

      - name: üë®‚Äçüîß Setup .NET Core SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: üîç Enable problem matchers
        run: echo "::add-matcher::.github/matchers/dotnet.json"

      - name: ü¶∏‚Äç‚ôÇÔ∏è Restore steriods
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          # Look to see if there is a cache hit for the corresponding requirements file
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget  

      - name: üõ†Ô∏è Compute version with GitVersion
        id: gitversion
        shell: pwsh
        run: |
          dotnet tool install --global GitVersion.Tool --version 5.*
          # echo "## üì¶ Calculated version" >> $GITHUB_STEP_SUMMARY
          # echo "" >> $GITHUB_STEP_SUMMARY
          $gitversion = & "dotnet-gitversion.exe" "/updateprojectfiles" "/output" "buildserver" "/nofetch" "/showvariable" "AssemblySemVer"
          $env:GITHUB_OUTPUT = "version=$gitversion"; 

      - name: üéí Load packages
        run: dotnet restore
      
      - name: üìù Set module version
        shell: pwsh
        id: version
        run: |
          $version = "${{ github.ref_name }}".Substring(1)
          $module = Get-Content -Path src\SvR.ContentPrep.Cmdlet\SvRooij.ContentPrep.Cmdlet.psd1
          $module = $module -replace 'ModuleVersion = ''\d+\.\d+\.\d+''', "ModuleVersion = '$version'"
          $module | Set-Content -Path src\SvR.ContentPrep.Cmdlet\SvRooij.ContentPrep.Cmdlet.psd1

      - name: üõ†Ô∏è Build PowerShell module
        shell: pwsh
        run: dotnet build .\src\SvR.ContentPrep.Cmdlet\SvR.ContentPrep.Cmdlet.csproj -c Release -p:Version=$("${{ github.ref_name }}".Substring(1)) -o .\dist\SvRooij.ContentPrep.Cmdlet  

      - name: üïµÔ∏è Import and test module
        shell: pwsh
        run: |
          Import-Module .\dist\SvRooij.ContentPrep.Cmdlet\SvRooij.ContentPrep.Cmdlet.psd1
          Get-Command -Module SvRooij.ContentPrep.Cmdlet
          Get-Command -Module SvRooij.ContentPrep.Cmdlet | Select-Object -ExpandProperty Name | ForEach-Object { Get-Help $_ -Full }

      - name: ‚úàÔ∏è Publish to PowerShell Gallery
        shell: pwsh
        run: |
          Import-Module .\dist\SvRooij.ContentPrep.Cmdlet\SvRooij.ContentPrep.Cmdlet.psd1
          Publish-Module -Path .\dist\SvRooij.ContentPrep.Cmdlet\ -NuGetApiKey ${{ secrets.PSGALLERY_API_KEY }} -Verbose

      # - name: Analyses
      #   shell: pwsh
      #   run: |
      #     Import-Module .\dist\SvRooij.ContentPrep.Cmdlet\SvR.ContentPrep.Cmdlet.psd1
      #     Install-Module -Name PSScriptAnalyzer
      #     Invoke-ScriptAnalyzer -Path .\dist\SvRooij.ContentPrep.Cmdlet\SvR.ContentPrep.Cmdlet.psd1
